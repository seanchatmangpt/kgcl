#!/usr/bin/env bash

# KGCL Pre-Push Hook - HEAVY Checks
# ----------------------------------
# Full validation before pushing to remote.
# These checks prevent corrupting the project.
#
# This hook runs:
#   1. Full test suite with PYTHONWARNINGS=error
#   2. Mypy strict type checking
#   3. Full lint check
#   4. Implementation lies detector (comprehensive)
#
# Total time: 30-120 seconds depending on test suite size

set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$REPO_ROOT"

if ! command -v uv >/dev/null 2>&1; then
  echo "ERROR: 'uv' is required. Install: https://github.com/astral-sh/uv"
  exit 1
fi

# KGC v3.0: Treat all Python warnings as errors
export PYTHONWARNINGS="error"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

FAILED=0

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "KGCL Pre-Push (Heavy Checks) - KGC v3.0 Andon Cord Mode"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Environment: PYTHONWARNINGS=error (all warnings are errors)"
echo "Mode: Full validation before push"
echo ""

# ============================================================================
# HEAVY CHECKS: Implementation Lies, Lint, Type Check, Tests
# ============================================================================
# Uses poe task for standardized execution (Lean Six Sigma quality)
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Running Pre-Push Heavy Checks"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Sequence: detect-lies â†’ lint-check â†’ type-check â†’ test-timeout"
echo ""

HEAVY_OUTPUT=$(timeout 120s uv run poe pre-push-heavy 2>&1)
HEAVY_EXIT=$?

if [ $HEAVY_EXIT -eq 0 ]; then
  echo ""
  echo -e "${GREEN}âœ“ All checks passed${NC}"
else
  echo ""
  echo -e "${RED}âœ— Checks failed${NC}"
  echo ""
  echo "ğŸ”§ How to fix:"
  echo "   1. Fix lies:  Complete all TODO/FIXME markers"
  echo "   2. Fix lint:  uv run poe lint"
  echo "   3. Fix types: uv run poe type-check"
  echo "   4. Fix tests: uv run poe test"
  echo "   5. Verify:    uv run poe pre-push-heavy"
  echo ""
  echo "ğŸ“Š What failed:"
  echo "$HEAVY_OUTPUT" | grep -E "(ERROR|FAILED|error)" | head -10
  echo ""
  echo "ğŸ“š See: docs/patterns/ERROR_HANDLING.md"
  echo "        docs/patterns/TYPE_SAFETY.md"
  echo "        docs/quality/FMEA.md"
  echo ""
  FAILED=1
fi

echo ""

# ============================================================================
# FINAL VERDICT
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "FINAL VERDICT"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

if [ "$FAILED" -eq 0 ]; then
  echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
  echo -e "${GREEN}â•‘                                                            â•‘${NC}"
  echo -e "${GREEN}â•‘  âœ“ ALL CHECKS PASSED - PUSH APPROVED                       â•‘${NC}"
  echo -e "${GREEN}â•‘                                                            â•‘${NC}"
  echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo ""
  exit 0
else
  echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
  echo -e "${RED}â•‘                                                            â•‘${NC}"
  echo -e "${RED}â•‘  âœ— ANDON CORD PULLED - PUSH BLOCKED                        â•‘${NC}"
  echo -e "${RED}â•‘                                                            â•‘${NC}"
  echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo ""
  echo -e "${RED}CRITICAL: Push blocked to prevent corrupting the project.${NC}"
  echo ""
  echo "Fix issues before pushing:"
  echo "  uv run poe lint           # Fix lint issues"
  echo "  uv run poe type-check     # Fix type errors"
  echo "  uv run poe test           # Fix test failures"
  echo "  uv run poe pre-push-heavy # Run all checks"
  echo ""
  exit 1
fi
