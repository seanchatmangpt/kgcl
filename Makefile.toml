[config]
# Cargo-make equivalent for Python projects
skip_core_tasks = false
on_error_task = "notification"
default_to_shell = "bash"

[tasks.default]
dependencies = ["format-check", "lint", "test"]
description = "Default task: format check, lint, and tests"

# Dependency Management
[tasks.sync]
command = "uv"
args = ["sync"]
description = "Sync dependencies (install all packages)"

[tasks.sync-prod]
command = "uv"
args = ["sync", "--no-dev"]
description = "Sync production dependencies only"

# Formatting
[tasks.format]
command = "uv"
args = ["run", "ruff", "format", "src", "tests"]
description = "Format code with Ruff"

[tasks.format-check]
command = "uv"
args = ["run", "ruff", "format", "--check", "src", "tests"]
description = "Check code formatting"

# Linting
[tasks.lint]
command = "uv"
args = ["run", "ruff", "check", "src", "tests", "--fix"]
description = "Run Ruff linter with fixes"

[tasks.lint-check]
command = "uv"
args = ["run", "ruff", "check", "src", "tests"]
description = "Check linting without fixing"

[tasks.type-check]
command = "uv"
args = ["run", "mypy", "src", "tests"]
description = "Type check with mypy"

[tasks.all-checks]
dependencies = ["format-check", "lint-check", "type-check"]
description = "Run all linting/type checks"

# Testing
[tasks.test]
command = "uv"
args = ["run", "pytest", "tests", "-v", "--tb=short"]
description = "Run all tests"

[tasks.test-fast]
command = "uv"
args = ["run", "pytest", "tests", "-x", "-q"]
description = "Run tests (exit on first failure, quiet)"

[tasks.test-coverage]
command = "uv"
args = ["run", "pytest", "tests", "--cov=src", "--cov-report=html", "--cov-report=term"]
description = "Run tests with coverage report"

[tasks.test-hooks]
command = "uv"
args = ["run", "pytest", "tests/hooks", "-v"]
description = "Run only hooks tests"

[tasks.test-unrdf]
command = "uv"
args = ["run", "pytest", "tests/integration/test_unrdf_porting.py", "-v"]
description = "Run only UNRDF porting tests"

[tasks.test-integration]
command = "uv"
args = ["run", "pytest", "tests/integration", "-v", "-m", "integration"]
description = "Run integration tests only"

[tasks.test-all-features]
command = "uv"
args = ["run", "pytest", "tests", "-v", "--tb=long", "-k", "not slow"]
description = "Run all tests with all features"

[tasks.test-timeout]
command = "timeout"
args = ["10m", "uv", "run", "pytest", "tests", "-x", "-q", "--tb=short"]
description = "Run tests with 10-minute timeout"

[tasks.test-watch]
command = "uv"
args = ["run", "pytest-watch", "tests", "--", "-x"]
description = "Watch tests (requires pytest-watch)"

# Building
[tasks.build]
command = "uv"
args = ["build"]
description = "Build distribution packages"

[tasks.build-check]
command = "uv"
args = ["sync"]
description = "Check dependencies and build can work"

# Documentation
[tasks.docs]
command = "uv"
args = ["run", "mkdocs", "build"]
description = "Build documentation"

[tasks.docs-serve]
command = "uv"
args = ["run", "mkdocs", "serve"]
description = "Serve documentation locally"

# Code Quality - Comprehensive
[tasks.verify]
description = "Verify code quality: format, lint, type-check, and tests"
dependencies = ["format-check", "lint-check", "type-check", "test-timeout"]

[tasks.verify-strict]
description = "Strict verification: all checks, coverage, doc build"
dependencies = [
    "format-check",
    "lint-check",
    "type-check",
    "test-coverage",
    "docs",
]

[tasks.ci]
description = "Run all CI checks (format, lint, types, tests, docs)"
dependencies = [
    "format-check",
    "lint-check",
    "type-check",
    "test-timeout",
    "docs",
]

# Pre-commit and Git Hooks
[tasks.pre-commit-setup]
script = '''
echo "Setting up git hooks..."
mkdir -p .githooks
chmod +x .githooks/pre-commit
git config core.hooksPath .githooks
echo "Git hooks installed to .githooks"
echo "Pre-commit hook is now active!"
'''
description = "Install git hooks"

[tasks.pre-commit-run]
script = '''
echo "Running pre-commit checks manually..."
if [ -f ".githooks/pre-commit" ]; then
  ./.githooks/pre-commit
else
  echo "Pre-commit hook not found at .githooks/pre-commit"
  exit 1
fi
'''
description = "Run pre-commit checks manually"

# Release Process
[tasks.release-check]
description = "Run all checks before release"
dependencies = [
    "format-check",
    "lint-check",
    "type-check",
    "test-coverage",
    "docs",
]

[tasks.release-notes]
script = '''
echo "Generating release notes from git log..."
git log --oneline --no-decorate $(git describe --tags --abbrev=0)..HEAD || git log --oneline -20
'''
description = "Show commits since last release"

[tasks.version-check]
script = '''
VERSION=$(grep '^version = ' pyproject.toml | head -1 | cut -d'"' -f2)
echo "Current version: $VERSION"
'''
description = "Show current project version"

# Utilities
[tasks.clean]
script = '''
echo "Cleaning build artifacts..."
find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
find . -type d -name .pytest_cache -exec rm -rf {} + 2>/dev/null || true
find . -type d -name .mypy_cache -exec rm -rf {} + 2>/dev/null || true
find . -type d -name *.egg-info -exec rm -rf {} + 2>/dev/null || true
rm -rf build/ dist/ reports/
echo "Clean complete"
'''
description = "Clean build artifacts and caches"

[tasks.audit]
command = "uv"
args = ["run", "pip-audit"]
description = "Run security audit on dependencies"

[tasks.update]
command = "uv"
args = ["lock", "--upgrade"]
description = "Update dependency lock file"

[tasks.install-deps]
script = '''
echo "Installing all development dependencies..."
uv sync
echo "Dependencies installed"
'''
description = "Install all dependencies"

[tasks.shell]
command = "uv"
args = ["run", "--no-project", "python3"]
description = "Enter Python shell with dependencies"

# Help and Information
[tasks.info]
script = '''
echo "KGCL Project Information"
echo "======================="
echo ""
echo "Available Tasks:"
cargo-make --list-all-steps
echo ""
echo "Python & UV Information:"
uv --version
python3 --version
echo ""
echo "Project Configuration:"
echo "  Python: $(grep requires-python pyproject.toml | cut -d'"' -f2)"
echo "  Version: $(grep '^version = ' pyproject.toml | cut -d'"' -f2)"
'''
description = "Show project information"

[tasks.help]
script = '''
echo ""
echo "KGCL Build System - Cargo-Make Equivalent"
echo "=========================================="
echo ""
echo "Common Tasks:"
echo "  cargo-make                  # Run default (format-check, lint, test)"
echo "  cargo-make verify           # Verify code quality"
echo "  cargo-make ci               # Run all CI checks"
echo "  cargo-make release-check    # Run all release checks"
echo ""
echo "Development:"
echo "  cargo-make format           # Format code"
echo "  cargo-make lint             # Run linter"
echo "  cargo-make type-check       # Type checking"
echo "  cargo-make test             # Run tests"
echo "  cargo-make test-coverage    # Run tests with coverage"
echo ""
echo "Code Quality:"
echo "  cargo-make all-checks       # Format + lint + type check"
echo "  cargo-make verify-strict    # All checks + coverage + docs"
echo ""
echo "Setup & Maintenance:"
echo "  cargo-make pre-commit-setup # Install git hooks"
echo "  cargo-make clean            # Clean artifacts"
echo "  cargo-make update           # Update dependencies"
echo "  cargo-make audit            # Security audit"
echo ""
echo "Documentation:"
echo "  cargo-make docs             # Build docs"
echo "  cargo-make docs-serve       # Serve docs locally"
echo ""
echo "For more tasks, use: cargo-make --list-all-steps"
echo ""
'''
description = "Show help information"

[tasks.notification]
script = '''
echo ""
echo "❌ Task failed - check output above"
echo ""
echo "Quick fixes:"
echo "  1. Format:    cargo-make format"
echo "  2. Lint:      cargo-make lint"
echo "  3. Types:     cargo-make type-check"
echo "  4. Tests:     cargo-make test"
echo ""
'''
description = "Error notification"

# Strict Build Settings - Production
[tasks.prod-build]
description = "Production build with strictest settings"
dependencies = [
    "format-check",
    "lint-check",
    "type-check",
    "test-coverage",
    "docs",
]
script = '''
echo ""
echo "✓ All strict build checks passed"
echo "✓ Ready for production deployment"
echo ""
'''

# Chicago School TDD
[tasks.tdd]
command = "uv"
args = ["run", "pytest", "tests/", "-v", "--tb=short", "--strict-markers"]
description = "Run tests in TDD mode with strict markers"

[tasks.tdd-watch]
command = "uv"
args = ["run", "pytest-watch", "tests/", "--", "-v", "--tb=short"]
description = "Watch tests in TDD mode"

# UNRDF-Specific
[tasks.unrdf-validate]
description = "Validate UNRDF porting"
dependencies = ["type-check", "test-unrdf"]

[tasks.unrdf-full]
script = '''
echo "Running comprehensive UNRDF validation..."
uv run pytest tests/integration/test_unrdf_porting.py \
  tests/hooks/test_security.py \
  tests/hooks/test_performance.py \
  tests/hooks/test_policy_packs.py \
  tests/hooks/test_file_resolver.py \
  -v --tb=short
'''
description = "Run all UNRDF porting tests"
