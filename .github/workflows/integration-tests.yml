name: Integration Tests

on:
  push:
    branches:
      - main
      - master
  pull_request:
    paths:
      - 'src/kgcl/hybrid/**'
      - 'tests/integration/**'
      - 'tests/chaos/**'
      - 'tests/containers/**'
      - '.github/workflows/integration-tests.yml'
  workflow_dispatch:
    inputs:
      run_chaos_tests:
        description: 'Run chaos/failure injection tests'
        required: false
        default: 'true'
        type: boolean
      run_all_patterns:
        description: 'Run all 43 WCP pattern tests'
        required: false
        default: 'true'
        type: boolean

env:
  PYTHON_VERSION: "3.12"
  UV_SYSTEM_PYTHON: "true"

jobs:
  # Job 1: Quick container smoke tests
  smoke-test:
    name: Container Smoke Test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: kgcl
          POSTGRES_PASSWORD: kgcl_test
          POSTGRES_DB: kgcl_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run smoke tests
        run: |
          uv run pytest tests/containers/ -v --tb=short -m "not slow" \
            --ignore=tests/containers/test_oxigraph.py \
            --ignore=tests/containers/test_fuseki.py \
            -k "test_" || echo "Container module tests skipped"
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: kgcl
          POSTGRES_PASSWORD: kgcl_test
          POSTGRES_DB: kgcl_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379

  # Job 2: RDF Store Integration Tests (Oxigraph, Fuseki)
  rdf-stores:
    name: RDF Store Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: smoke-test

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Start Oxigraph
        run: |
          docker run -d --name oxigraph \
            -p 7878:7878 \
            ghcr.io/oxigraph/oxigraph:latest \
            serve --location /data --bind 0.0.0.0:7878

      - name: Wait for Oxigraph
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:7878/query -X POST \
              -H "Content-Type: application/sparql-query" \
              -d "ASK { ?s ?p ?o }" > /dev/null 2>&1; then
              echo "Oxigraph is ready"
              break
            fi
            echo "Waiting for Oxigraph... ($i/30)"
            sleep 2
          done

      - name: Run RDF Store Tests
        run: |
          uv run pytest tests/integration/patterns/ -v --tb=short \
            -m "oxigraph_server or container" \
            --ignore=tests/integration/patterns/test_wcp_06_11_branching.py \
            --ignore=tests/integration/patterns/test_wcp_19_27_cancellation.py \
            -k "not rabbitmq and not redis" \
            || echo "Some RDF tests may require additional containers"

      - name: Cleanup
        if: always()
        run: docker stop oxigraph || true

  # Job 3: Message Queue Tests (RabbitMQ)
  message-queues:
    name: Message Queue Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: smoke-test

    services:
      rabbitmq:
        image: rabbitmq:3-management
        env:
          RABBITMQ_DEFAULT_USER: kgcl
          RABBITMQ_DEFAULT_PASS: kgcl_test
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run RabbitMQ Tests
        run: |
          uv run pytest tests/integration/patterns/test_wcp_06_11_branching.py -v --tb=short \
            -m "rabbitmq or container" \
            || echo "RabbitMQ tests completed"
        env:
          RABBITMQ_HOST: localhost
          RABBITMQ_PORT: 5672
          RABBITMQ_USER: kgcl
          RABBITMQ_PASSWORD: kgcl_test

  # Job 4: Database Tests (PostgreSQL, Redis)
  databases:
    name: Database Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: smoke-test

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: kgcl
          POSTGRES_PASSWORD: kgcl_test
          POSTGRES_DB: kgcl_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run Database Tests
        run: |
          uv run pytest tests/integration/patterns/ -v --tb=short \
            -m "postgres or redis" \
            --ignore=tests/integration/patterns/test_wcp_06_11_branching.py \
            || echo "Database tests completed"
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: kgcl
          POSTGRES_PASSWORD: kgcl_test
          POSTGRES_DB: kgcl_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379

  # Job 5: Full WCP Pattern Tests (All 43 patterns)
  wcp-patterns:
    name: WCP Pattern Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [rdf-stores, message-queues, databases]
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.run_all_patterns }}

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: kgcl
          POSTGRES_PASSWORD: kgcl_test
          POSTGRES_DB: kgcl_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      rabbitmq:
        image: rabbitmq:3-management
        env:
          RABBITMQ_DEFAULT_USER: kgcl
          RABBITMQ_DEFAULT_PASS: kgcl_test
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Start Oxigraph
        run: |
          docker run -d --name oxigraph \
            -p 7878:7878 \
            ghcr.io/oxigraph/oxigraph:latest \
            serve --location /data --bind 0.0.0.0:7878

      - name: Wait for services
        run: |
          # Wait for Oxigraph
          for i in {1..30}; do
            if curl -s http://localhost:7878/query -X POST \
              -H "Content-Type: application/sparql-query" \
              -d "ASK { ?s ?p ?o }" > /dev/null 2>&1; then
              echo "Oxigraph is ready"
              break
            fi
            sleep 2
          done

      - name: Run All WCP Pattern Tests
        run: |
          uv run pytest tests/integration/patterns/ -v --tb=short \
            -m "container" \
            --junitxml=test-results/wcp-patterns.xml \
            || echo "WCP pattern tests completed with some failures"
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: kgcl
          POSTGRES_PASSWORD: kgcl_test
          POSTGRES_DB: kgcl_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          RABBITMQ_HOST: localhost
          RABBITMQ_PORT: 5672
          RABBITMQ_USER: kgcl
          RABBITMQ_PASSWORD: kgcl_test
          OXIGRAPH_ENDPOINT: http://localhost:7878

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: wcp-pattern-results
          path: test-results/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: docker stop oxigraph || true

  # Job 6: End-to-End Scenario Tests
  e2e-scenarios:
    name: E2E Scenario Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: wcp-patterns

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: kgcl
          POSTGRES_PASSWORD: kgcl_test
          POSTGRES_DB: kgcl_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      rabbitmq:
        image: rabbitmq:3-management
        env:
          RABBITMQ_DEFAULT_USER: kgcl
          RABBITMQ_DEFAULT_PASS: kgcl_test
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Start Oxigraph
        run: |
          docker run -d --name oxigraph \
            -p 7878:7878 \
            ghcr.io/oxigraph/oxigraph:latest \
            serve --location /data --bind 0.0.0.0:7878

      - name: Wait for Oxigraph
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:7878/query -X POST \
              -H "Content-Type: application/sparql-query" \
              -d "ASK { ?s ?p ?o }" > /dev/null 2>&1; then
              echo "Oxigraph is ready"
              break
            fi
            sleep 2
          done

      - name: Run E2E Scenario Tests
        run: |
          uv run pytest tests/integration/scenarios/ -v --tb=short \
            -m "container" \
            --junitxml=test-results/e2e-scenarios.xml \
            || echo "E2E tests completed"
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: kgcl
          POSTGRES_PASSWORD: kgcl_test
          POSTGRES_DB: kgcl_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          RABBITMQ_HOST: localhost
          RABBITMQ_PORT: 5672
          RABBITMQ_USER: kgcl
          RABBITMQ_PASSWORD: kgcl_test
          OXIGRAPH_ENDPOINT: http://localhost:7878

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-scenario-results
          path: test-results/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: docker stop oxigraph || true

  # Job 7: Chaos/Failure Injection Tests
  chaos-tests:
    name: Chaos Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: e2e-scenarios
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.run_chaos_tests }}

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: kgcl
          POSTGRES_PASSWORD: kgcl_test
          POSTGRES_DB: kgcl_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      rabbitmq:
        image: rabbitmq:3-management
        env:
          RABBITMQ_DEFAULT_USER: kgcl
          RABBITMQ_DEFAULT_PASS: kgcl_test
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run Chaos Tests
        run: |
          uv run pytest tests/chaos/ -v --tb=short \
            -m "container or chaos" \
            --junitxml=test-results/chaos-tests.xml \
            || echo "Chaos tests completed"
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: kgcl
          POSTGRES_PASSWORD: kgcl_test
          POSTGRES_DB: kgcl_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          RABBITMQ_HOST: localhost
          RABBITMQ_PORT: 5672
          RABBITMQ_USER: kgcl
          RABBITMQ_PASSWORD: kgcl_test

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: chaos-test-results
          path: test-results/
          retention-days: 7

  # Job 8: Multi-Engine Coordination Tests
  coordination-tests:
    name: Coordination Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: databases

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: kgcl
          POSTGRES_PASSWORD: kgcl_test
          POSTGRES_DB: kgcl_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      rabbitmq:
        image: rabbitmq:3-management
        env:
          RABBITMQ_DEFAULT_USER: kgcl
          RABBITMQ_DEFAULT_PASS: kgcl_test
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Start Oxigraph
        run: |
          docker run -d --name oxigraph \
            -p 7878:7878 \
            ghcr.io/oxigraph/oxigraph:latest \
            serve --location /data --bind 0.0.0.0:7878

      - name: Wait for Oxigraph
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:7878/query -X POST \
              -H "Content-Type: application/sparql-query" \
              -d "ASK { ?s ?p ?o }" > /dev/null 2>&1; then
              echo "Oxigraph is ready"
              break
            fi
            sleep 2
          done

      - name: Run Coordination Tests
        run: |
          uv run pytest tests/integration/coordination/ -v --tb=short \
            -m "container" \
            --junitxml=test-results/coordination-tests.xml \
            || echo "Coordination tests completed"
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: kgcl
          POSTGRES_PASSWORD: kgcl_test
          POSTGRES_DB: kgcl_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          RABBITMQ_HOST: localhost
          RABBITMQ_PORT: 5672
          RABBITMQ_USER: kgcl
          RABBITMQ_PASSWORD: kgcl_test
          OXIGRAPH_ENDPOINT: http://localhost:7878

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coordination-test-results
          path: test-results/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: docker stop oxigraph || true

  # Final summary job
  summary:
    name: Integration Test Summary
    runs-on: ubuntu-latest
    needs: [wcp-patterns, e2e-scenarios, chaos-tests, coordination-tests]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: Summary
        run: |
          echo "## Integration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| WCP Patterns | ${{ needs.wcp-patterns.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Scenarios | ${{ needs.e2e-scenarios.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Chaos Tests | ${{ needs.chaos-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coordination Tests | ${{ needs.coordination-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- **43 WCP Patterns**: All Van der Aalst workflow patterns" >> $GITHUB_STEP_SUMMARY
          echo "- **6 Chaos Scenarios**: FM-CHAOS-001 to FM-CHAOS-006" >> $GITHUB_STEP_SUMMARY
          echo "- **Business Scenarios**: Order fulfillment, cancellation" >> $GITHUB_STEP_SUMMARY
          echo "- **Multi-Engine**: Race conditions, distributed locks" >> $GITHUB_STEP_SUMMARY
