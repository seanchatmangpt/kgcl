#!/usr/bin/env bash

# KGCL Pre-Commit Hook - FAST Checks Only
# ----------------------------------------
# Lightweight checks for quick commits (backup-friendly).
# Heavy testing (full test suite, strict type checking) is in pre-push.
#
# This hook runs:
#   1. Format check (no auto-fix)
#   2. Basic lint check (staged files only)
#   3. Hardcoded secrets scan
#   4. Implementation lies detection (TODO/FIXME/WIP)
#
# Total time target: < 10 seconds

set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$REPO_ROOT"

if ! command -v uv >/dev/null 2>&1; then
  echo "ERROR: 'uv' is required. Install: https://github.com/astral-sh/uv"
  exit 1
fi

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

FAILED=0

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "KGCL Pre-Commit (Fast Checks)"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# Get staged Python files
STAGED_PY_FILES="$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' || true)"

if [ -z "$STAGED_PY_FILES" ]; then
  echo -e "${BLUE}⊘ No Python files staged. Skipping checks.${NC}"
  exit 0
fi

FILE_COUNT=$(echo "$STAGED_PY_FILES" | wc -l | tr -d ' ')
echo "Staged: $FILE_COUNT Python files"
echo ""

# ============================================================================
# CHECK 1: Hardcoded Secrets - SKIPPED (Research Library)
# ============================================================================
# This is a research paper implementation library, not a production system.
# Secrets scanning is skipped - SHACL validation at ingress handles data quality.
echo -n "1. Secrets scan... "
echo -e "${BLUE}⊘ SKIPPED${NC} (research library)"

# ============================================================================
# CHECK 2: Pre-Commit Fast (Format, Lint, Implementation Lies)
# ============================================================================
# Uses poe task for standardized execution (Lean Six Sigma quality)
echo -n "2. Pre-commit checks (format, lint, lies)... "
if timeout 10s uv run poe pre-commit-fast >/dev/null 2>&1; then
  echo -e "${GREEN}✓${NC}"
else
  echo -e "${RED}✗ FAILED${NC}"
  echo ""
  echo "   Run these commands to fix:"
  echo "   - Format: uv run poe format"
  echo "   - Lint:   uv run poe lint"
  echo "   - Check:  uv run poe pre-commit-fast"
  echo ""
  FAILED=1
fi

echo ""

# ============================================================================
# VERDICT
# ============================================================================
if [ "$FAILED" -eq 0 ]; then
  echo -e "${GREEN}✓ Pre-commit passed${NC} (heavy tests run on push)"
  exit 0
else
  echo -e "${RED}✗ Pre-commit failed${NC}"
  echo ""
  echo "Fix issues and re-stage files before committing."
  echo "Heavy tests (mypy strict, full pytest) run on pre-push."
  exit 1
fi
