openapi: 3.0.0
info:
  title: KGC Atman Engine API
  version: 1.0.0
  description: |
    # The Atman Monolith - Diamond Standard Knowledge Graph Mutation Engine

    ## Philosophy: The Chatman Equation (A = μ(O))

    The Atman Engine implements deterministic knowledge graph mutations with:
    - **Data Integrity** - QuadDelta captures intent immutably
    - **Logic Integrity** - logic_hash proves which laws applied
    - **History Integrity** - merkle_root links transactions in a chain

    ## Core Concepts

    ### The Chatman Equation: A = μ(O)
    - **O (Observation)**: QuadDelta - The intent to mutate reality
    - **μ (Operator)**: Atman - The deterministic mutation engine
    - **A (Action)**: Receipt - Cryptographic proof of execution

    ### The Hot Path
    All operations complete in <100ms (p99) with batch size limited by
    the Chatman Constant (64 triples).

    ### The Lockchain
    Every transaction creates a cryptographic receipt linking to the
    previous state, forming an immutable chain of provenance.

    ## Architecture

    ```
    ┌─────────────────────────────────────────────────┐
    │  QuadDelta (Observation)                        │
    │  - additions: Triple[]                          │
    │  - removals: Triple[]                           │
    └──────────────────┬──────────────────────────────┘
                       │
                       ▼
    ┌─────────────────────────────────────────────────┐
    │  Atman Engine (Operator μ)                      │
    │  1. PRE Hooks (Guards)                          │
    │  2. State Mutation                              │
    │  3. POST Hooks (Side Effects)                   │
    │  4. Receipt Generation                          │
    └──────────────────┬──────────────────────────────┘
                       │
                       ▼
    ┌─────────────────────────────────────────────────┐
    │  Receipt (Action)                               │
    │  - merkle_root: Hash(Prev + Delta)              │
    │  - logic_hash: Hash(Active_Hooks)               │
    │  - hook_results: Telemetry[]                    │
    └─────────────────────────────────────────────────┘
    ```

    ## Hook System

    ### PRE Hooks (Blocking Guards)
    - Execute before mutation
    - Can block transaction by returning False
    - Run in priority order (high → low)
    - Example: Prevent deletion of system triples

    ### POST Hooks (Side Effects)
    - Execute after successful mutation
    - Cannot block transaction
    - Run asynchronously
    - Example: Send notifications, update caches

    ## Performance Targets

    | Operation | p50 | p99 | Target |
    |-----------|-----|-----|--------|
    | Hook registration | 0.1ms | 1.0ms | <5ms |
    | Transaction apply | 2.0ms | 50.0ms | <100ms |
    | Logic hash | 0.5ms | 5.0ms | <10ms |
    | Batch (64 triples) | 10.0ms | 100.0ms | <100ms |

    ## Security Model

    - **Immutability**: QuadDelta is frozen after creation
    - **Determinism**: Same input → Same merkle_root
    - **Provenance**: Every receipt links to previous state
    - **Auditability**: Hook execution fully logged

  contact:
    name: KGCL Team
    url: https://github.com/kgcl/kgcl
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8000/api/v1
    description: Local development server
  - url: https://api.kgcl.io/v1
    description: Production server

tags:
  - name: Transactions
    description: Knowledge graph mutation operations
  - name: Hooks
    description: Hook registration and management
  - name: Provenance
    description: Chain verification and receipts
  - name: Queries
    description: Read operations on the knowledge graph

paths:
  /transactions:
    post:
      summary: Apply a transaction to the knowledge graph
      description: |
        Execute the Chatman Equation: A = μ(O)

        This operation:
        1. Validates the QuadDelta against the Chatman Constant
        2. Runs PRE hooks (guards) in priority order
        3. Atomically applies additions and removals
        4. Runs POST hooks (side effects)
        5. Returns cryptographic Receipt

        **Atomicity**: If any PRE hook returns False, the entire
        transaction is aborted and no mutations are applied.

        **Performance**: Completes in <100ms (p99) for batches up to 64 triples.
      operationId: applyTransaction
      tags:
        - Transactions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransactionRequest'
            examples:
              simple_addition:
                summary: Add a single triple
                value:
                  delta:
                    additions:
                      - ["urn:entity:123", "rdf:type", "schema:Person"]
                  actor: "user:alice"
              batch_mutation:
                summary: Add and remove triples
                value:
                  delta:
                    additions:
                      - ["urn:entity:123", "schema:name", "Alice"]
                      - ["urn:entity:123", "schema:email", "alice@example.com"]
                    removals:
                      - ["urn:entity:123", "schema:status", "pending"]
                  actor: "system:migration"
      responses:
        '200':
          description: Transaction applied successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Receipt'
              examples:
                successful:
                  summary: Successful transaction
                  value:
                    tx_id: "550e8400-e29b-41d4-a716-446655440000"
                    committed: true
                    merkle_root: "a7b8c9d0e1f2g3h4i5j6k7l8m9n0o1p2q3r4s5t6u7v8w9x0y1z2a3b4c5d6e7f8"
                    logic_hash: "b8c9d0e1f2g3h4i5j6k7l8m9n0o1p2q3r4s5t6u7v8w9x0y1z2a3b4c5d6e7f8g9"
                    hook_results:
                      - hook_id: "validate-schema"
                        mode: "pre"
                        success: true
                        duration_ns: 1250000
                      - hook_id: "update-cache"
                        mode: "post"
                        success: true
                        duration_ns: 850000
                    duration_ns: 2500000
                    error: null
        '400':
          description: Invalid request (batch size exceeds limit, malformed data)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                batch_too_large:
                  summary: Batch exceeds Chatman Constant
                  value:
                    error: "Topology Violation: Batch size 128 exceeds Hot Path limit (64)"
                    code: "CHATMAN_VIOLATION"
        '403':
          description: Transaction blocked by PRE hook
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Receipt'
              examples:
                guard_blocked:
                  summary: Guard hook blocked transaction
                  value:
                    tx_id: "550e8400-e29b-41d4-a716-446655440001"
                    committed: false
                    merkle_root: "a7b8c9d0e1f2g3h4i5j6k7l8m9n0o1p2q3r4s5t6u7v8w9x0y1z2a3b4c5d6e7f8"
                    logic_hash: "b8c9d0e1f2g3h4i5j6k7l8m9n0o1p2q3r4s5t6u7v8w9x0y1z2a3b4c5d6e7f8g9"
                    hook_results:
                      - hook_id: "protect-system"
                        mode: "pre"
                        success: false
                        duration_ns: 500000
                    duration_ns: 750000
                    error: "Guard Violation: protect-system"

  /hooks:
    get:
      summary: List all registered hooks
      description: |
        Returns all hooks in execution order (priority descending, then ID ascending).

        Hooks are sorted deterministically to ensure consistent execution order.
      operationId: listHooks
      tags:
        - Hooks
      responses:
        '200':
          description: List of registered hooks
          content:
            application/json:
              schema:
                type: object
                properties:
                  hooks:
                    type: array
                    items:
                      $ref: '#/components/schemas/HookInfo'
                  total:
                    type: integer
                    description: Total number of registered hooks
              examples:
                hook_list:
                  summary: Two registered hooks
                  value:
                    hooks:
                      - id: "protect-system"
                        mode: "pre"
                        priority: 200
                        signature: "protect-system:pre:200"
                      - id: "update-cache"
                        mode: "post"
                        priority: 100
                        signature: "update-cache:post:100"
                    total: 2

    post:
      summary: Register a new hook
      description: |
        Register a custom hook to extend engine behavior.

        **PRE Hooks**: Act as guards, can block transactions
        **POST Hooks**: Act as side effects, run after mutation

        Hooks are executed in deterministic order:
        1. Priority (descending)
        2. Hook ID (ascending)
      operationId: registerHook
      tags:
        - Hooks
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HookRegistration'
            examples:
              pre_guard:
                summary: Register a PRE guard hook
                value:
                  hook_id: "validate-schema"
                  mode: "pre"
                  priority: 150
                  handler_url: "https://hooks.example.com/validate"
                  config:
                    schema_version: "1.0"
              post_effect:
                summary: Register a POST side effect
                value:
                  hook_id: "notify-slack"
                  mode: "post"
                  priority: 50
                  handler_url: "https://hooks.example.com/notify"
                  config:
                    channel: "#kgcl-updates"
      responses:
        '201':
          description: Hook registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HookInfo'
        '400':
          description: Invalid hook configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Hook with this ID already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /hooks/{hookId}:
    delete:
      summary: Unregister a hook
      description: Remove a hook from the engine by its ID.
      operationId: unregisterHook
      tags:
        - Hooks
      parameters:
        - name: hookId
          in: path
          required: true
          schema:
            type: string
          description: Unique identifier of the hook to unregister
          example: "validate-schema"
      responses:
        '204':
          description: Hook unregistered successfully
        '404':
          description: Hook not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /provenance/tip:
    get:
      summary: Get current chain tip
      description: |
        Returns the hash of the most recent committed transaction.

        This is the tip of the Lockchain, representing the current state.
      operationId: getChainTip
      tags:
        - Provenance
      responses:
        '200':
          description: Current chain tip
          content:
            application/json:
              schema:
                type: object
                properties:
                  tip_hash:
                    type: string
                    format: sha256-hex
                    description: SHA256 hash of the last committed transaction
                    example: "a7b8c9d0e1f2g3h4i5j6k7l8m9n0o1p2q3r4s5t6u7v8w9x0y1z2a3b4c5d6e7f8"
                  is_genesis:
                    type: boolean
                    description: Whether this is the genesis hash (no transactions yet)
                    example: false

  /provenance/logic-hash:
    get:
      summary: Get current logic hash
      description: |
        Returns the hash of the current engine configuration (registered hooks).

        The logic hash proves which laws are active. If hooks are added/removed,
        the logic hash changes, and this is reflected in future receipts.
      operationId: getLogicHash
      tags:
        - Provenance
      responses:
        '200':
          description: Current logic hash
          content:
            application/json:
              schema:
                type: object
                properties:
                  logic_hash:
                    type: string
                    format: sha256-hex
                    description: SHA256 hash of hook signatures
                    example: "b8c9d0e1f2g3h4i5j6k7l8m9n0o1p2q3r4s5t6u7v8w9x0y1z2a3b4c5d6e7f8g9"
                  hook_count:
                    type: integer
                    description: Number of registered hooks
                    example: 3

  /triples:
    get:
      summary: Query triples in the knowledge graph
      description: |
        Execute a SPARQL query against the current knowledge graph state.

        Supports full SPARQL 1.1 syntax including:
        - SELECT, CONSTRUCT, ASK, DESCRIBE
        - FILTER, OPTIONAL, UNION
        - Property paths
        - Aggregations
      operationId: queryTriples
      tags:
        - Queries
      parameters:
        - name: query
          in: query
          required: true
          schema:
            type: string
          description: SPARQL query string
          example: "SELECT ?s ?p ?o WHERE { ?s ?p ?o } LIMIT 10"
        - name: format
          in: query
          schema:
            type: string
            enum: [json, xml, turtle, ntriples]
            default: json
          description: Result format
      responses:
        '200':
          description: Query results
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: object
                    properties:
                      bindings:
                        type: array
                        items:
                          type: object
              examples:
                select_results:
                  summary: SELECT query results
                  value:
                    results:
                      bindings:
                        - s: { type: "uri", value: "urn:entity:123" }
                          p: { type: "uri", value: "rdf:type" }
                          o: { type: "uri", value: "schema:Person" }
        '400':
          description: Invalid SPARQL query
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /health:
    get:
      summary: Health check endpoint
      description: Returns engine health status and metrics.
      operationId: healthCheck
      tags:
        - Monitoring
      responses:
        '200':
          description: Engine is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy, degraded, unhealthy]
                    example: "healthy"
                  metrics:
                    type: object
                    properties:
                      total_triples:
                        type: integer
                        description: Total triples in the store
                      total_transactions:
                        type: integer
                        description: Total committed transactions
                      registered_hooks:
                        type: integer
                        description: Number of registered hooks
                      tip_hash:
                        type: string
                        description: Current chain tip
                      uptime_seconds:
                        type: number
                        description: Engine uptime in seconds

components:
  schemas:
    TransactionRequest:
      type: object
      required:
        - delta
      properties:
        delta:
          $ref: '#/components/schemas/QuadDelta'
        actor:
          type: string
          description: Identity of the actor initiating the transaction
          default: "system"
          example: "user:alice"

    QuadDelta:
      type: object
      description: |
        The Observation (O) in the Chatman Equation.

        Represents the intent to mutate reality. Immutable once created.
        Batch size must not exceed the Chatman Constant (64).
      properties:
        additions:
          type: array
          items:
            $ref: '#/components/schemas/Triple'
          description: Triples to add to the knowledge graph
          maxItems: 64
          default: []
        removals:
          type: array
          items:
            $ref: '#/components/schemas/Triple'
          description: Triples to remove from the knowledge graph
          maxItems: 64
          default: []
      example:
        additions:
          - ["urn:entity:123", "rdf:type", "schema:Person"]
          - ["urn:entity:123", "schema:name", "Alice"]
        removals:
          - ["urn:entity:123", "schema:status", "pending"]

    Triple:
      type: array
      description: |
        RDF Triple: [Subject, Predicate, Object]

        All elements are strings. URIs are detected by presence of '://' or ':'.
        Other values are treated as literals.
      minItems: 3
      maxItems: 3
      items:
        type: string
      example: ["urn:entity:123", "rdf:type", "schema:Person"]

    Receipt:
      type: object
      description: |
        The Action (A) in the Chatman Equation.

        Cryptographic proof of: State + Logic + History
      required:
        - tx_id
        - committed
        - merkle_root
        - logic_hash
        - hook_results
        - duration_ns
      properties:
        tx_id:
          type: string
          format: uuid
          description: Unique transaction identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
        committed:
          type: boolean
          description: Whether the transaction was successfully committed
          example: true
        merkle_root:
          type: string
          format: sha256-hex
          description: Hash(Prev + Delta) - Links to previous state
          example: "a7b8c9d0e1f2g3h4i5j6k7l8m9n0o1p2q3r4s5t6u7v8w9x0y1z2a3b4c5d6e7f8"
        logic_hash:
          type: string
          format: sha256-hex
          description: Hash(Active_Hooks) - Proves which laws applied
          example: "b8c9d0e1f2g3h4i5j6k7l8m9n0o1p2q3r4s5t6u7v8w9x0y1z2a3b4c5d6e7f8g9"
        hook_results:
          type: array
          items:
            $ref: '#/components/schemas/HookResult'
          description: Results from all executed hooks
        duration_ns:
          type: integer
          format: int64
          description: Total transaction duration in nanoseconds
          example: 2500000
        error:
          type: string
          nullable: true
          description: Error message if transaction failed
          example: null

    HookResult:
      type: object
      description: Result of a single hook execution
      required:
        - hook_id
        - mode
        - success
        - duration_ns
      properties:
        hook_id:
          type: string
          description: Identifier of the executed hook
          example: "validate-schema"
        mode:
          type: string
          enum: [pre, post]
          description: Hook execution mode
          example: "pre"
        success:
          type: boolean
          description: Whether the hook executed successfully
          example: true
        duration_ns:
          type: integer
          format: int64
          description: Execution duration in nanoseconds
          example: 1250000

    HookRegistration:
      type: object
      description: Hook registration request
      required:
        - hook_id
        - mode
        - handler_url
      properties:
        hook_id:
          type: string
          description: Unique identifier for this hook
          pattern: '^[a-z0-9-]+$'
          example: "validate-schema"
        mode:
          type: string
          enum: [pre, post]
          description: |
            - pre: Blocking guard (executes before mutation)
            - post: Side effect (executes after mutation)
          example: "pre"
        priority:
          type: integer
          description: Execution priority (higher = earlier)
          default: 100
          minimum: 0
          maximum: 1000
          example: 150
        handler_url:
          type: string
          format: uri
          description: Webhook URL for hook handler
          example: "https://hooks.example.com/validate"
        config:
          type: object
          description: Hook-specific configuration
          additionalProperties: true
          example:
            schema_version: "1.0"

    HookInfo:
      type: object
      description: Information about a registered hook
      required:
        - id
        - mode
        - priority
        - signature
      properties:
        id:
          type: string
          description: Hook identifier
          example: "validate-schema"
        mode:
          type: string
          enum: [pre, post]
          description: Hook mode
          example: "pre"
        priority:
          type: integer
          description: Hook priority
          example: 150
        signature:
          type: string
          description: Deterministic signature for logic hashing
          example: "validate-schema:pre:150"

    Error:
      type: object
      required:
        - error
        - code
      properties:
        error:
          type: string
          description: Human-readable error message
          example: "Topology Violation: Batch size 128 exceeds Hot Path limit (64)"
        code:
          type: string
          description: Machine-readable error code
          example: "CHATMAN_VIOLATION"
        details:
          type: object
          description: Additional error details
          additionalProperties: true

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authentication

    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token authentication

security:
  - ApiKeyAuth: []
  - BearerAuth: []
