#!/usr/bin/env bash

# KGCL Pre-Commit Hook - FAST Checks Only
# ----------------------------------------
# Lightweight checks for quick commits (backup-friendly).
# Heavy testing (full test suite, strict type checking) is in pre-push.
#
# This hook runs:
#   1. Format check (no auto-fix)
#   2. Basic lint check (staged files only)
#   3. Hardcoded secrets scan
#   4. Implementation lies detection (TODO/FIXME/WIP)
#
# Total time target: < 10 seconds

set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$REPO_ROOT"

if ! command -v uv >/dev/null 2>&1; then
  echo "ERROR: 'uv' is required. Install: https://github.com/astral-sh/uv"
  exit 1
fi

RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

FAILED=0

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "KGCL Pre-Commit (Fast Checks)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Get staged Python files
STAGED_PY_FILES="$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' || true)"

if [ -z "$STAGED_PY_FILES" ]; then
  echo -e "${BLUE}âŠ˜ No Python files staged. Skipping checks.${NC}"
  exit 0
fi

FILE_COUNT=$(echo "$STAGED_PY_FILES" | wc -l | tr -d ' ')
echo "Staged: $FILE_COUNT Python files"
echo ""

# ============================================================================
# CHECK 1: Hardcoded Secrets - SKIPPED (Research Library)
# ============================================================================
# This is a research paper implementation library, not a production system.
# Secrets scanning is skipped - SHACL validation at ingress handles data quality.
echo -n "1. Secrets scan... "
echo -e "${BLUE}âŠ˜ SKIPPED${NC} (research library)"

# ============================================================================
# CHECK 2: Pre-Commit Fast (Format, Lint, Implementation Lies)
# ============================================================================
# Uses poe task for standardized execution (Lean Six Sigma quality)
echo -n "2. Pre-commit checks (format, lint, lies)... "
PRE_COMMIT_OUTPUT=$(timeout 10s uv run poe pre-commit-fast 2>&1)
if [ $? -eq 0 ]; then
  echo -e "${GREEN}âœ“ PASSED${NC}"
else
  echo -e "${RED}âœ— FAILED${NC}"
  echo ""
  echo "ğŸ”§ How to fix:"
  echo "   1. Run format: uv run poe format"
  echo "   2. Run lint:   uv run poe lint"
  echo "   3. Verify:     uv run poe pre-commit-fast"
  echo ""
  echo "ğŸ“Š What failed:"
  echo "$PRE_COMMIT_OUTPUT" | grep -E "(ERROR|Would reformat|Found.*error)" | head -5
  echo ""
  echo "ğŸ“š See: docs/patterns/ERROR_HANDLING.md"
  echo "        docs/patterns/TYPE_SAFETY.md"
  echo ""
  FAILED=1
fi

echo ""

# ============================================================================
# ANDON SIGNAL - VERDICT
# ============================================================================
if [ "$FAILED" -eq 0 ]; then
  echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
  echo -e "${GREEN}â•‘  âœ“ PRE-COMMIT PASSED                       â•‘${NC}"
  echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo ""
  echo "Quality gate: CLEAR âœ…"
  echo "Heavy validation runs on pre-push (mypy, full tests)"
  exit 0
else
  echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
  echo -e "${RED}â•‘  âœ— ANDON CORD PULLED - COMMIT BLOCKED      â•‘${NC}"
  echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo ""
  echo "ğŸ”´ Quality gate: STOP"
  echo ""
  echo "Lean Six Sigma principle: Fix defects immediately, don't defer."
  echo "Fix all issues above, then re-stage and commit."
  echo ""
  echo "ğŸ“š Quality standards: docs/quality/FMEA.md"
  exit 1
fi
