# =============================================================================
# SPARQL TEMPLATE ARCHITECTURE - ONTOLOGY PATCH
# =============================================================================
#
# This file contains the EXACT changes to add to kgc_physics.ttl
# for SPARQL template architecture support.
#
# VERSION: 4.0.0
# DATE: 2025-11-25
# AUTHOR: SPARQL-Template-Architect-2
#
# INSTRUCTIONS:
# 1. Add SECTION 18 (Template Schema) to kgc_physics.ttl
# 2. Add SECTION 19 (Parameter Value Resources) to kgc_physics.ttl
# 3. Add SECTION 20 (Execution Templates) to kgc_physics.ttl
# 4. REPLACE existing pattern mappings to use resources instead of literals
#
# =============================================================================

@prefix kgc: <http://bitflow.ai/ontology/kgc/v3#> .
@prefix yawl: <http://www.yawlfoundation.org/yawlschema#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

# =============================================================================
# SECTION 18: EXECUTION TEMPLATE SCHEMA (NEW)
# =============================================================================

kgc:ExecutionTemplate a rdfs:Class ;
    rdfs:label "Execution Template"@en ;
    rdfs:comment "SPARQL query template for parameter-specific verb execution."@en ;
    rdfs:isDefinedBy <http://bitflow.ai/ontology/kgc/v3#> .

kgc:executionTemplate a rdf:Property ;
    rdfs:label "execution template"@en ;
    rdfs:domain rdfs:Resource ;
    rdfs:range kgc:ExecutionTemplate ;
    rdfs:comment "Links parameter value resource to SPARQL execution template."@en .

kgc:targetQuery a rdf:Property ;
    rdfs:label "target query"@en ;
    rdfs:domain kgc:ExecutionTemplate ;
    rdfs:range xsd:string ;
    rdfs:comment "SPARQL SELECT query to find target nodes for verb execution."@en .

kgc:tokenMutations a rdf:Property ;
    rdfs:label "token mutations"@en ;
    rdfs:domain kgc:ExecutionTemplate ;
    rdfs:range xsd:string ;
    rdfs:comment "SPARQL CONSTRUCT query to mutate token state."@en .

kgc:instanceGeneration a rdf:Property ;
    rdfs:label "instance generation"@en ;
    rdfs:domain kgc:ExecutionTemplate ;
    rdfs:range xsd:string ;
    rdfs:comment "SPARQL CONSTRUCT for multiple instance (MI) creation."@en .

kgc:TemplateVariable a rdfs:Class ;
    rdfs:label "Template Variable"@en ;
    rdfs:comment "Placeholder variable in template queries (%TARGETS%, %TX_ID%, etc.)."@en .

# Template variable definitions for documentation
kgc:TARGETS a kgc:TemplateVariable ;
    rdfs:label "%TARGETS%"@en ;
    rdfs:comment "Injected target URIs from targetQuery results."@en .

kgc:TX_ID a kgc:TemplateVariable ;
    rdfs:label "%TX_ID%"@en ;
    rdfs:comment "Injected transaction ID from execution context."@en .

kgc:SUBJECT a kgc:TemplateVariable ;
    rdfs:label "%SUBJECT%"@en ;
    rdfs:comment "Injected current node URI."@en .

kgc:MI_ITEMS a kgc:TemplateVariable ;
    rdfs:label "%MI_ITEMS%"@en ;
    rdfs:comment "Injected MI data items from execution context."@en .

# =============================================================================
# SECTION 19: PARAMETER VALUE RESOURCES (NEW)
# =============================================================================
#
# These replace literal values like "topology", "all", "exactlyOne".
# Each value becomes a resource that can have an attached template.
#
# =============================================================================

# -----------------------------------------------------------------------------
# PARAMETER 1: Threshold (AWAIT verb)
# -----------------------------------------------------------------------------

kgc:AllThreshold a rdfs:Resource ;
    rdfs:label "all"@en ;
    kgc:description "Wait for ALL incoming branches to complete."@en ;
    kgc:patternUsage "WCP-3: Synchronization (AND-join)"@en .

kgc:OneThreshold a rdfs:Resource ;
    rdfs:label "1"@en ;
    kgc:description "Wait for FIRST incoming branch to complete (discriminator)."@en ;
    kgc:patternUsage "WCP-9: Discriminator"@en .

kgc:ActiveThreshold a rdfs:Resource ;
    rdfs:label "active"@en ;
    kgc:description "Wait for all ACTIVE (non-voided) branches to complete."@en ;
    kgc:patternUsage "WCP-7: Structured Synchronizing Merge (OR-join)"@en .

kgc:DynamicThreshold a rdfs:Resource ;
    rdfs:label "dynamic"@en ;
    kgc:description "Threshold determined at runtime from data."@en ;
    kgc:patternUsage "WCP-36: Dynamic Partial Join for MI"@en .

kgc:MilestoneThreshold a rdfs:Resource ;
    rdfs:label "milestone"@en ;
    kgc:description "Task enabled only while milestone is active."@en ;
    kgc:patternUsage "WCP-18: Milestone"@en .

# -----------------------------------------------------------------------------
# PARAMETER 2: Cardinality (COPY verb)
# -----------------------------------------------------------------------------

kgc:TopologyCardinality a rdfs:Resource ;
    rdfs:label "topology"@en ;
    kgc:description "Use graph topology to determine number of copies (ALL successors)."@en ;
    kgc:patternUsage "WCP-2: Parallel Split (AND-split)"@en .

kgc:StaticCardinality a rdfs:Resource ;
    rdfs:label "static"@en ;
    kgc:description "Number of copies known at design time (from min/max properties)."@en ;
    kgc:patternUsage "WCP-13: MI with Design-Time Knowledge"@en .

kgc:DynamicCardinality a rdfs:Resource ;
    rdfs:label "dynamic"@en ;
    kgc:description "Number of copies determined at runtime from data."@en ;
    kgc:patternUsage "WCP-14: MI with Runtime Knowledge"@en .

kgc:IncrementalCardinality a rdfs:Resource ;
    rdfs:label "incremental"@en ;
    kgc:description "Instances created incrementally during execution."@en ;
    kgc:patternUsage "WCP-15: MI without Prior Runtime Knowledge"@en .

# -----------------------------------------------------------------------------
# PARAMETER 3: Completion Strategy (AWAIT verb)
# -----------------------------------------------------------------------------

kgc:WaitAllStrategy a rdfs:Resource ;
    rdfs:label "waitAll"@en ;
    kgc:description "Wait for ALL branches to complete."@en ;
    kgc:patternUsage "WCP-3: Synchronization"@en .

kgc:WaitActiveStrategy a rdfs:Resource ;
    rdfs:label "waitActive"@en ;
    kgc:description "Wait for all ACTIVE branches (ignore voided)."@en ;
    kgc:patternUsage "WCP-7: Structured Synchronizing Merge"@en .

kgc:WaitFirstStrategy a rdfs:Resource ;
    rdfs:label "waitFirst"@en ;
    kgc:description "Fire on FIRST arrival, ignore subsequent."@en ;
    kgc:patternUsage "WCP-9: Discriminator"@en .

kgc:WaitQuorumStrategy a rdfs:Resource ;
    rdfs:label "waitQuorum"@en ;
    kgc:description "Fire when N of M instances complete."@en ;
    kgc:patternUsage "WCP-34: Static Partial Join for MI"@en .

# -----------------------------------------------------------------------------
# PARAMETER 4: Selection Mode (FILTER verb)
# -----------------------------------------------------------------------------

kgc:ExactlyOneSelection a rdfs:Resource ;
    rdfs:label "exactlyOne"@en ;
    kgc:description "Select EXACTLY ONE path based on predicate (XOR-split)."@en ;
    kgc:patternUsage "WCP-4: Exclusive Choice"@en .

kgc:OneOrMoreSelection a rdfs:Resource ;
    rdfs:label "oneOrMore"@en ;
    kgc:description "Select ONE OR MORE paths based on predicates (OR-split)."@en ;
    kgc:patternUsage "WCP-6: Multi-Choice"@en .

kgc:DeferredSelection a rdfs:Resource ;
    rdfs:label "deferred"@en ;
    kgc:description "Defer selection to environment/resource (runtime choice)."@en ;
    kgc:patternUsage "WCP-16: Deferred Choice"@en .

kgc:MutexSelection a rdfs:Resource ;
    rdfs:label "mutex"@en ;
    kgc:description "Mutual exclusion - one task at a time."@en ;
    kgc:patternUsage "WCP-17: Interleaved Parallel Routing"@en .

# -----------------------------------------------------------------------------
# PARAMETER 5: Cancellation Scope (VOID verb)
# -----------------------------------------------------------------------------

kgc:SelfScope a rdfs:Resource ;
    rdfs:label "self"@en ;
    kgc:description "Cancel only the current task."@en ;
    kgc:patternUsage "WCP-19: Cancel Task"@en .

kgc:RegionScope a rdfs:Resource ;
    rdfs:label "region"@en ;
    kgc:description "Cancel all tasks in cancellation region."@en ;
    kgc:patternUsage "WCP-21: Cancel Region"@en .

kgc:CaseScope a rdfs:Resource ;
    rdfs:label "case"@en ;
    kgc:description "Cancel entire case (all tasks)."@en ;
    kgc:patternUsage "WCP-20: Cancel Case"@en .

kgc:InstancesScope a rdfs:Resource ;
    rdfs:label "instances"@en ;
    kgc:description "Cancel all instances of MI task."@en ;
    kgc:patternUsage "WCP-22: Cancel MI Activity"@en .

kgc:TaskScope a rdfs:Resource ;
    rdfs:label "task"@en ;
    kgc:description "Cancel task and transition to exception handler."@en ;
    kgc:patternUsage "WCP-24: Exception Handling"@en .

# -----------------------------------------------------------------------------
# PARAMETER 7: Instance Binding (MI patterns)
# -----------------------------------------------------------------------------

kgc:NoneBinding a rdfs:Resource ;
    rdfs:label "none"@en ;
    kgc:description "No instance-specific data binding."@en .

kgc:IndexBinding a rdfs:Resource ;
    rdfs:label "index"@en ;
    kgc:description "Bind instance index to task data."@en ;
    kgc:patternUsage "WCP-13: MI with Design-Time Knowledge"@en .

kgc:DataBinding a rdfs:Resource ;
    rdfs:label "data"@en ;
    kgc:description "Bind runtime data item to each instance."@en ;
    kgc:patternUsage "WCP-14: MI with Runtime Knowledge"@en .

kgc:RecursiveBinding a rdfs:Resource ;
    rdfs:label "recursive"@en ;
    kgc:description "Bind to parent instance for recursion."@en ;
    kgc:patternUsage "WCP-27: Recursion"@en .

# =============================================================================
# SECTION 20: EXECUTION TEMPLATES (NEW)
# =============================================================================
#
# Attach SPARQL execution templates to parameter value resources.
# Each template defines HOW to execute a verb with that parameter value.
#
# =============================================================================

# -----------------------------------------------------------------------------
# COPY VERB - CARDINALITY TEMPLATES
# -----------------------------------------------------------------------------

# Template 1: Topology Cardinality (WCP-2: Parallel Split)
kgc:TopologyCardinality
    kgc:executionTemplate kgc:TopologyTemplate .

kgc:TopologyTemplate a kgc:ExecutionTemplate ;
    rdfs:label "Topology Cardinality Template"@en ;
    rdfs:comment "Clone token to ALL successors found in graph topology."@en ;
    kgc:targetQuery """PREFIX yawl: <http://www.yawlfoundation.org/yawlschema#>
SELECT ?next WHERE {
    ?subject yawl:flowsInto ?flow .
    ?flow yawl:nextElementRef ?next .
}""" ;
    kgc:tokenMutations """PREFIX kgc: <http://bitflow.ai/ontology/kgc/v3#>
CONSTRUCT {
    ?subject kgc:hasToken false .
    ?next kgc:hasToken true .
    ?subject kgc:completedAt ?txId .
} WHERE {
    ?subject kgc:hasToken true .
    VALUES ?next { %TARGETS% }
    VALUES ?txId { %TX_ID% }
}""" .

# Template 2: Static Cardinality (WCP-13: MI with Design-Time Knowledge)
kgc:StaticCardinality
    kgc:executionTemplate kgc:StaticTemplate .

kgc:StaticTemplate a kgc:ExecutionTemplate ;
    rdfs:label "Static Cardinality Template"@en ;
    rdfs:comment "Create N instances where N is known at design time."@en ;
    kgc:targetQuery """PREFIX yawl: <http://www.yawlfoundation.org/yawlschema#>
SELECT ?next ?min ?max WHERE {
    ?subject yawl:minimum ?min ;
             yawl:maximum ?max ;
             yawl:flowsInto ?flow .
    ?flow yawl:nextElementRef ?next .
    FILTER(?min = ?max)
}
LIMIT 1""" ;
    kgc:instanceGeneration """PREFIX kgc: <http://bitflow.ai/ontology/kgc/v3#>
CONSTRUCT {
    ?instance a kgc:MIInstance ;
              kgc:instanceId ?index ;
              kgc:baseTask ?baseTarget .
} WHERE {
    VALUES ?baseTarget { %BASE_TARGET% }
    VALUES ?count { %STATIC_COUNT% }
    BIND(URI(CONCAT(STR(?baseTarget), "_instance_", STR(?index))) AS ?instance)
    BIND(%RANGE_ITERATOR% AS ?index)
}""" ;
    kgc:tokenMutations """PREFIX kgc: <http://bitflow.ai/ontology/kgc/v3#>
CONSTRUCT {
    ?subject kgc:hasToken false .
    ?instance kgc:hasToken true .
    ?subject kgc:completedAt ?txId .
} WHERE {
    ?subject kgc:hasToken true .
    ?instance a kgc:MIInstance .
    VALUES ?txId { %TX_ID% }
}""" .

# Template 3: Dynamic Cardinality (WCP-14: MI with Runtime Knowledge)
kgc:DynamicCardinality
    kgc:executionTemplate kgc:DynamicTemplate .

kgc:DynamicTemplate a kgc:ExecutionTemplate ;
    rdfs:label "Dynamic Cardinality Template"@en ;
    rdfs:comment "Create N instances where N is determined at runtime from data."@en ;
    kgc:targetQuery """PREFIX yawl: <http://www.yawlfoundation.org/yawlschema#>
SELECT ?next WHERE {
    ?subject yawl:flowsInto ?flow .
    ?flow yawl:nextElementRef ?next .
}
LIMIT 1""" ;
    kgc:instanceGeneration """PREFIX kgc: <http://bitflow.ai/ontology/kgc/v3#>
CONSTRUCT {
    ?instance a kgc:MIInstance ;
              kgc:instanceId ?index ;
              kgc:boundData ?item ;
              kgc:baseTask ?baseTarget .
} WHERE {
    VALUES ?baseTarget { %BASE_TARGET% }
    VALUES ?items { %MI_ITEMS% }
    BIND(URI(CONCAT(STR(?baseTarget), "_instance_", STR(?index))) AS ?instance)
    BIND(%INDEX_ITERATOR% AS ?index)
    BIND(%ITEM_ITERATOR% AS ?item)
}""" ;
    kgc:tokenMutations """PREFIX kgc: <http://bitflow.ai/ontology/kgc/v3#>
CONSTRUCT {
    ?subject kgc:hasToken false .
    ?instance kgc:hasToken true .
    ?subject kgc:completedAt ?txId .
} WHERE {
    ?subject kgc:hasToken true .
    ?instance a kgc:MIInstance .
    VALUES ?txId { %TX_ID% }
}""" .

# -----------------------------------------------------------------------------
# AWAIT VERB - THRESHOLD TEMPLATES
# -----------------------------------------------------------------------------

# Template 4: All Threshold (WCP-3: Synchronization)
kgc:AllThreshold
    kgc:executionTemplate kgc:AllThresholdTemplate .

kgc:AllThresholdTemplate a kgc:ExecutionTemplate ;
    rdfs:label "All Threshold Template"@en ;
    rdfs:comment "Wait for ALL incoming branches to complete."@en ;
    kgc:targetQuery """PREFIX yawl: <http://www.yawlfoundation.org/yawlschema#>
PREFIX kgc: <http://bitflow.ai/ontology/kgc/v3#>
SELECT ?next (COUNT(?incoming) AS ?total) (SUM(IF(?hasToken, 1, 0)) AS ?completed) WHERE {
    ?subject yawl:flowsInto ?outFlow .
    ?outFlow yawl:nextElementRef ?next .
    ?incoming yawl:flowsInto ?inFlow .
    ?inFlow yawl:nextElementRef ?subject .
    OPTIONAL { ?incoming kgc:hasToken ?hasToken . }
}
GROUP BY ?next
HAVING (?total = ?completed)""" ;
    kgc:tokenMutations """PREFIX kgc: <http://bitflow.ai/ontology/kgc/v3#>
PREFIX yawl: <http://www.yawlfoundation.org/yawlschema#>
CONSTRUCT {
    ?incoming kgc:hasToken false .
    ?next kgc:hasToken true .
    ?subject kgc:completedAt ?txId .
} WHERE {
    VALUES ?next { %TARGETS% }
    VALUES ?txId { %TX_ID% }
    ?incoming yawl:flowsInto/yawl:nextElementRef ?subject .
    ?incoming kgc:hasToken true .
}""" .

# Template 5: First Threshold (WCP-9: Discriminator)
kgc:OneThreshold
    kgc:executionTemplate kgc:FirstThresholdTemplate .

kgc:FirstThresholdTemplate a kgc:ExecutionTemplate ;
    rdfs:label "First Threshold Template"@en ;
    rdfs:comment "Fire on FIRST arrival, ignore subsequent arrivals."@en ;
    kgc:targetQuery """PREFIX yawl: <http://www.yawlfoundation.org/yawlschema#>
PREFIX kgc: <http://bitflow.ai/ontology/kgc/v3#>
SELECT ?next WHERE {
    ?subject yawl:flowsInto ?outFlow .
    ?outFlow yawl:nextElementRef ?next .
    FILTER NOT EXISTS { ?subject kgc:discriminatorFired true . }
}""" ;
    kgc:tokenMutations """PREFIX kgc: <http://bitflow.ai/ontology/kgc/v3#>
PREFIX yawl: <http://www.yawlfoundation.org/yawlschema#>
CONSTRUCT {
    ?firstIncoming kgc:hasToken false .
    ?next kgc:hasToken true .
    ?subject kgc:discriminatorFired true .
    ?subject kgc:completedAt ?txId .
} WHERE {
    VALUES ?next { %TARGETS% }
    VALUES ?txId { %TX_ID% }
    {
        SELECT ?firstIncoming WHERE {
            ?firstIncoming yawl:flowsInto/yawl:nextElementRef ?subject ;
                           kgc:hasToken true .
        } LIMIT 1
    }
}""" .

# Template 6: Active Threshold (WCP-7: Structured Synchronizing Merge)
kgc:ActiveThreshold
    kgc:executionTemplate kgc:ActiveThresholdTemplate .

kgc:ActiveThresholdTemplate a kgc:ExecutionTemplate ;
    rdfs:label "Active Threshold Template"@en ;
    rdfs:comment "Wait for all ACTIVE (non-voided) branches."@en ;
    kgc:targetQuery """PREFIX yawl: <http://www.yawlfoundation.org/yawlschema#>
PREFIX kgc: <http://bitflow.ai/ontology/kgc/v3#>
SELECT ?next (COUNT(?incoming) AS ?total) (SUM(IF(?hasToken, 1, 0)) AS ?completed) (SUM(IF(?voided, 1, 0)) AS ?voidedCount) WHERE {
    ?subject yawl:flowsInto ?outFlow .
    ?outFlow yawl:nextElementRef ?next .
    ?incoming yawl:flowsInto ?inFlow .
    ?inFlow yawl:nextElementRef ?subject .
    OPTIONAL { ?incoming kgc:hasToken ?hasToken . }
    OPTIONAL { ?incoming kgc:voidedAt ?voided . }
}
GROUP BY ?next
HAVING ((?total - ?voidedCount) = ?completed)""" ;
    kgc:tokenMutations """PREFIX kgc: <http://bitflow.ai/ontology/kgc/v3#>
PREFIX yawl: <http://www.yawlfoundation.org/yawlschema#>
CONSTRUCT {
    ?incoming kgc:hasToken false .
    ?next kgc:hasToken true .
    ?subject kgc:completedAt ?txId .
} WHERE {
    VALUES ?next { %TARGETS% }
    VALUES ?txId { %TX_ID% }
    ?incoming yawl:flowsInto/yawl:nextElementRef ?subject .
    ?incoming kgc:hasToken true .
    FILTER NOT EXISTS { ?incoming kgc:voidedAt ?voided . }
}""" .

# -----------------------------------------------------------------------------
# FILTER VERB - SELECTION MODE TEMPLATES
# -----------------------------------------------------------------------------

# Template 7: Exactly One (WCP-4: Exclusive Choice)
kgc:ExactlyOneSelection
    kgc:executionTemplate kgc:ExactlyOneTemplate .

kgc:ExactlyOneTemplate a kgc:ExecutionTemplate ;
    rdfs:label "Exactly One Selection Template"@en ;
    rdfs:comment "Select EXACTLY ONE path (XOR-split)."@en ;
    kgc:targetQuery """PREFIX yawl: <http://www.yawlfoundation.org/yawlschema#>
SELECT ?next ?predicate ?ordering WHERE {
    ?subject yawl:flowsInto ?flow .
    ?flow yawl:nextElementRef ?next .
    OPTIONAL {
        ?flow yawl:hasPredicate/yawl:query ?predicate ;
              yawl:hasPredicate/yawl:ordering ?ordering .
    }
    FILTER(%PREDICATE_EVAL%)
}
ORDER BY ?ordering
LIMIT 1""" ;
    kgc:tokenMutations """PREFIX kgc: <http://bitflow.ai/ontology/kgc/v3#>
CONSTRUCT {
    ?subject kgc:hasToken false .
    ?next kgc:hasToken true .
    ?subject kgc:completedAt ?txId .
} WHERE {
    VALUES ?next { %TARGETS% }
    VALUES ?txId { %TX_ID% }
    ?subject kgc:hasToken true .
}""" .

# Template 8: One or More (WCP-6: Multi-Choice)
kgc:OneOrMoreSelection
    kgc:executionTemplate kgc:OneOrMoreTemplate .

kgc:OneOrMoreTemplate a kgc:ExecutionTemplate ;
    rdfs:label "One or More Selection Template"@en ;
    rdfs:comment "Select ONE OR MORE paths (OR-split)."@en ;
    kgc:targetQuery """PREFIX yawl: <http://www.yawlfoundation.org/yawlschema#>
SELECT ?next WHERE {
    ?subject yawl:flowsInto ?flow .
    ?flow yawl:nextElementRef ?next .
    OPTIONAL { ?flow yawl:hasPredicate/yawl:query ?predicate . }
    FILTER(%PREDICATE_EVAL%)
}""" ;
    kgc:tokenMutations """PREFIX kgc: <http://bitflow.ai/ontology/kgc/v3#>
CONSTRUCT {
    ?subject kgc:hasToken false .
    ?next kgc:hasToken true .
    ?subject kgc:completedAt ?txId .
} WHERE {
    VALUES ?next { %TARGETS% }
    VALUES ?txId { %TX_ID% }
    ?subject kgc:hasToken true .
}""" .

# -----------------------------------------------------------------------------
# VOID VERB - CANCELLATION SCOPE TEMPLATES
# -----------------------------------------------------------------------------

# Template 9: Self Scope (WCP-19: Cancel Task)
kgc:SelfScope
    kgc:executionTemplate kgc:SelfScopeTemplate .

kgc:SelfScopeTemplate a kgc:ExecutionTemplate ;
    rdfs:label "Self Scope Template"@en ;
    rdfs:comment "Cancel only the current task."@en ;
    kgc:targetQuery """SELECT ?subject WHERE {
    VALUES ?subject { %SUBJECT% }
}""" ;
    kgc:tokenMutations """PREFIX kgc: <http://bitflow.ai/ontology/kgc/v3#>
CONSTRUCT {
    ?subject kgc:hasToken false .
    ?subject kgc:voidedAt ?txId .
    ?subject kgc:status "Voided" .
} WHERE {
    VALUES ?subject { %SUBJECT% }
    VALUES ?txId { %TX_ID% }
}""" .

# Template 10: Region Scope (WCP-21: Cancel Region)
kgc:RegionScope
    kgc:executionTemplate kgc:RegionScopeTemplate .

kgc:RegionScopeTemplate a kgc:ExecutionTemplate ;
    rdfs:label "Region Scope Template"@en ;
    rdfs:comment "Cancel all tasks in cancellation region."@en ;
    kgc:targetQuery """PREFIX yawl: <http://www.yawlfoundation.org/yawlschema#>
PREFIX kgc: <http://bitflow.ai/ontology/kgc/v3#>
SELECT ?task WHERE {
    ?subject yawl:hasCancellationRegion ?region .
    ?region yawl:containsTask ?task .
    ?task kgc:hasToken true .
}""" ;
    kgc:tokenMutations """PREFIX kgc: <http://bitflow.ai/ontology/kgc/v3#>
CONSTRUCT {
    ?task kgc:hasToken false .
    ?task kgc:voidedAt ?txId .
    ?task kgc:status "Voided" .
} WHERE {
    VALUES ?task { %TARGETS% }
    VALUES ?txId { %TX_ID% }
}""" .

# Template 11: Case Scope (WCP-20: Cancel Case)
kgc:CaseScope
    kgc:executionTemplate kgc:CaseScopeTemplate .

kgc:CaseScopeTemplate a kgc:ExecutionTemplate ;
    rdfs:label "Case Scope Template"@en ;
    rdfs:comment "Cancel entire case (all tasks)."@en ;
    kgc:targetQuery """PREFIX yawl: <http://www.yawlfoundation.org/yawlschema#>
PREFIX kgc: <http://bitflow.ai/ontology/kgc/v3#>
SELECT ?task WHERE {
    ?subject yawl:belongsToCase ?case .
    ?task yawl:belongsToCase ?case ;
          kgc:hasToken true .
}""" ;
    kgc:tokenMutations """PREFIX kgc: <http://bitflow.ai/ontology/kgc/v3#>
PREFIX yawl: <http://www.yawlfoundation.org/yawlschema#>
CONSTRUCT {
    ?task kgc:hasToken false .
    ?task kgc:voidedAt ?txId .
    ?task kgc:status "Voided" .
    ?case kgc:status "Terminated" .
} WHERE {
    VALUES ?task { %TARGETS% }
    VALUES ?txId { %TX_ID% }
    ?task yawl:belongsToCase ?case .
}""" .

# =============================================================================
# SECTION 21: UPDATED PATTERN MAPPINGS
# =============================================================================
#
# REPLACE existing pattern mappings to use RESOURCES instead of LITERALS.
# Examples below show the key patterns.
#
# =============================================================================

# WCP-2: Parallel Split (BEFORE: kgc:hasCardinality "topology")
kgc:WCP2_ParallelSplit a kgc:PatternMapping ;
    rdfs:label "WCP-2: Parallel Split → Copy"@en ;
    kgc:pattern yawl:ControlTypeAnd ;
    kgc:triggerProperty yawl:hasSplit ;
    kgc:triggerValue yawl:ControlTypeAnd ;
    kgc:verb kgc:Copy ;
    kgc:hasCardinality kgc:TopologyCardinality ;  # RESOURCE, not literal
    rdfs:comment "Divergence into multiple parallel branches."@en .

# WCP-3: Synchronization (BEFORE: kgc:hasThreshold "all")
kgc:WCP3_Synchronization a kgc:PatternMapping ;
    rdfs:label "WCP-3: Synchronization → Await(all)"@en ;
    kgc:pattern yawl:ControlTypeAnd ;
    kgc:triggerProperty yawl:hasJoin ;
    kgc:triggerValue yawl:ControlTypeAnd ;
    kgc:verb kgc:Await ;
    kgc:hasThreshold kgc:AllThreshold ;           # RESOURCE, not literal
    kgc:completionStrategy kgc:WaitAllStrategy ;  # RESOURCE, not literal
    rdfs:comment "Convergence requiring ALL branches to complete."@en .

# WCP-4: Exclusive Choice (BEFORE: kgc:selectionMode "exactlyOne")
kgc:WCP4_ExclusiveChoice a kgc:PatternMapping ;
    rdfs:label "WCP-4: Exclusive Choice → Filter(exactlyOne)"@en ;
    kgc:pattern yawl:ControlTypeXor ;
    kgc:triggerProperty yawl:hasSplit ;
    kgc:triggerValue yawl:ControlTypeXor ;
    kgc:verb kgc:Filter ;
    kgc:selectionMode kgc:ExactlyOneSelection ;   # RESOURCE, not literal
    rdfs:comment "Exactly ONE branch selected based on predicate."@en .

# WCP-14: MI with Runtime Knowledge (BEFORE: kgc:hasCardinality "dynamic")
kgc:WCP14_MIRuntime a kgc:PatternMapping ;
    rdfs:label "WCP-14: MI Runtime → Copy(dynamic)+Await(all)"@en ;
    kgc:pattern yawl:MultiInstanceTask ;
    kgc:condition "ASK { ?task yawl:miDataInput ?input }" ;
    kgc:verb kgc:Copy ;
    kgc:hasCardinality kgc:DynamicCardinality ;   # RESOURCE, not literal
    kgc:instanceBinding kgc:DataBinding ;         # RESOURCE, not literal
    rdfs:comment "N determined at runtime from data."@en .

# WCP-19: Cancel Task (BEFORE: kgc:cancellationScope "self")
kgc:WCP19_CancelTask a kgc:PatternMapping ;
    rdfs:label "WCP-19: Cancel Task → Void(self)"@en ;
    kgc:pattern yawl:CancelTask ;
    kgc:verb kgc:Void ;
    kgc:cancellationScope kgc:SelfScope ;         # RESOURCE, not literal
    rdfs:comment "Withdraw task before completion."@en .

# =============================================================================
# END OF ONTOLOGY PATCH
# =============================================================================
#
# INSTRUCTIONS FOR APPLICATION:
#
# 1. Open ontology/kgc_physics.ttl
# 2. Add SECTION 18 (Template Schema) after current Section 17
# 3. Add SECTION 19 (Parameter Value Resources) after Section 18
# 4. Add SECTION 20 (Execution Templates) after Section 19
# 5. REPLACE all 43 pattern mappings (Sections 4-14) with updated versions
#    that use RESOURCES instead of literal values
#
# VALIDATION:
#
# 1. Run SHACL validation: rdflib validates schema
# 2. Test templates in SPARQL playground (http://yasgui.org)
# 3. Verify all 18 templates can be queried successfully
# 4. Check ontology serialization is valid Turtle
#
# =============================================================================
