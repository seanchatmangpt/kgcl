# KGCL Cursor Rules - Strictest Production Standards
# Based on core KGCL Python patterns aligned with UNRDF porting

## Core Principles
1. **Chicago School TDD**: Tests drive all development. No mocking domain objects.
2. **Type Safety**: Full type hints everywhere. `poe type-check` must pass with `strict = true`.
3. **Production-Grade**: Code ready for immediate production use without refactoring.
4. **UNRDF Alignment**: Port UNRDF JavaScript patterns to Python idiomatically.
5. **No Tech Debt**: Clean code first time. No "TODO: refactor later".
6. **Write It Right**: Line length 88, no unused imports/vars, full type hints from the start.

## üö® WRITE IT RIGHT THE FIRST TIME

**PRE-PUSH HOOK BLOCKS ALL PUSHES WITH ERRORS.** Write correct code from the start.

### Critical Rules (Enforced by Pre-Push Hook)

| Rule | Error Code | What It Means |
|------|------------|---------------|
| Line length ‚â§ 88 | E501 | Break long lines into multiple lines |
| No unused imports | F401 | Remove imports you don't use |
| No unused variables | F841 | Remove or use assigned variables |
| Full type hints | Mypy | Every function needs param and return types |
| No TODO/FIXME/WIP | Lies | Complete the work, no deferred implementation |

### Line Length Examples (88 chars MAX)
```python
# ‚ùå WRONG - These lines are too long
async def execute_hook_with_timeout(self, hook: Hook, context: HookContext, timeout_seconds: float = 30.0) -> HookReceipt:

receipt = HookReceipt(execution_id=str(uuid4()), hook_id=hook.name, status=HookStatus.SUCCESS, duration_ms=duration, metadata={"phase": phase.value})

validated_results: list[ValidationResult] = [validator.validate(entity, schema) for validator, entity, schema in zip(validators, entities, schemas)]

# ‚úÖ CORRECT - Break at 88 characters
async def execute_hook_with_timeout(
    self,
    hook: Hook,
    context: HookContext,
    timeout_seconds: float = 30.0,
) -> HookReceipt:

receipt = HookReceipt(
    execution_id=str(uuid4()),
    hook_id=hook.name,
    status=HookStatus.SUCCESS,
    duration_ms=duration,
    metadata={"phase": phase.value},
)

validated_results: list[ValidationResult] = [
    validator.validate(entity, schema)
    for validator, entity, schema in zip(validators, entities, schemas)
]
```

### Unused Imports Examples (F401)
```python
# ‚ùå WRONG - Unused imports after refactoring (common mistake)
from dataclasses import dataclass, field, asdict, replace  # asdict, replace unused
from typing import Any, Callable, TypeVar, Generic, Protocol  # Generic, Protocol unused
from kgcl.hooks.core import Hook, HookReceipt, HookRegistry, HookExecutor  # HookExecutor unused
from kgcl.hooks.conditions import (
    Condition, ThresholdCondition, SparqlAskCondition,  # SparqlAskCondition unused
    TimeWindowCondition, CompositeCondition,  # CompositeCondition unused
)
import json  # Was used in deleted code

# ‚úÖ CORRECT - Only import what you actually use
from dataclasses import dataclass, field
from typing import Any, Callable, TypeVar
from kgcl.hooks.core import Hook, HookReceipt, HookRegistry
from kgcl.hooks.conditions import Condition, ThresholdCondition, TimeWindowCondition
```

### Unused Variables Examples (F841)
```python
# ‚ùå WRONG - Variables assigned but never read
async def process_hooks(self, hooks: list[Hook], context: HookContext) -> list[HookReceipt]:
    start_time = datetime.now(timezone.utc)
    results: list[HookReceipt] = []
    error_count = 0  # Assigned but never read

    for idx, hook in enumerate(hooks):
        hook_start = datetime.now(timezone.utc)  # Assigned but never read
        receipt = await self.execute(hook, context)
        elapsed = (datetime.now(timezone.utc) - hook_start).total_seconds()  # Never used
        results.append(receipt)

    total_duration = (datetime.now(timezone.utc) - start_time).total_seconds()  # Never used
    return results

# ‚úÖ CORRECT - Remove unused or actually use them
async def process_hooks(self, hooks: list[Hook], context: HookContext) -> list[HookReceipt]:
    results: list[HookReceipt] = []
    for hook in hooks:
        receipt = await self.execute(hook, context)
        results.append(receipt)
    return results
```

### Type Hints Examples (Mypy strict)
```python
# ‚ùå WRONG - Missing or incomplete type hints
class HookProcessor:
    def __init__(self, registry, executor, cache=None):  # No types!
        self.registry = registry
        self.executor = executor
        self.cache = cache or {}

    async def process(self, event):  # No types!
        hooks = self.registry.get_hooks_for_event(event)
        return [await self.executor.execute(h, event) for h in hooks]

# ‚úÖ CORRECT - Full type hints everywhere
class HookProcessor:
    def __init__(
        self,
        registry: HookRegistry,
        executor: HookExecutor,
        cache: dict[str, HookReceipt] | None = None,
    ) -> None:
        self.registry: HookRegistry = registry
        self.executor: HookExecutor = executor
        self.cache: dict[str, HookReceipt] = cache or {}

    async def process(self, event: dict[str, Any]) -> list[HookReceipt]:
        hooks: list[Hook] = self.registry.get_hooks_for_event(event)
        return [await self.executor.execute(h, event) for h in hooks]
```

### Dataclass Examples (Common Mistakes)
```python
# ‚ùå WRONG - Mutable default, missing generic types, line too long
@dataclass
class HookConfiguration:
    name: str
    conditions: list = field(default_factory=list)  # Missing generic
    handlers: dict = field(default_factory=dict)  # Missing generics
    metadata = {}  # WRONG: Mutable default!
    retry_policy: RetryPolicy = RetryPolicy(max_retries=3, backoff_seconds=1.0, retry_on=[TimeoutError, ConnectionError])

# ‚úÖ CORRECT - Immutable, fully typed, formatted
@dataclass(frozen=True)
class HookConfiguration:
    name: str
    conditions: list[Condition] = field(default_factory=list)
    handlers: dict[str, Callable[[HookContext], Awaitable[Any]]] = field(
        default_factory=dict
    )
    metadata: dict[str, str] = field(default_factory=dict)
    retry_policy: RetryPolicy = field(
        default_factory=lambda: RetryPolicy(
            max_retries=3,
            backoff_seconds=1.0,
            retry_on=[TimeoutError, ConnectionError],
        )
    )
```

## File Organization
```
kgcl/
‚îú‚îÄ‚îÄ pyproject.toml              # Strictest build settings (lint rules enabled)
‚îú‚îÄ‚îÄ scripts/git_hooks/
‚îÇ   ‚îú‚îÄ‚îÄ pre-commit              # Fast checks (<10s) - allows backups
‚îÇ   ‚îî‚îÄ‚îÄ pre-push                # Heavy checks (30-120s) - blocks corruption
‚îú‚îÄ‚îÄ .cursor/
‚îÇ   ‚îú‚îÄ‚îÄ commands/               # Slash command definitions
‚îÇ   ‚îî‚îÄ‚îÄ rules.md                # This file
‚îú‚îÄ‚îÄ src/kgcl/                   # Source code (all typed)
‚îÇ   ‚îú‚îÄ‚îÄ hooks/                  # Knowledge Hooks system
‚îÇ   ‚îú‚îÄ‚îÄ unrdf_engine/           # UNRDF integration
‚îÇ   ‚îú‚îÄ‚îÄ ontology/               # RDF/SHACL definitions
‚îÇ   ‚îî‚îÄ‚îÄ cli/                    # Command-line interface
‚îú‚îÄ‚îÄ tests/                      # Test suite (Chicago School TDD)
‚îÇ   ‚îú‚îÄ‚îÄ hooks/                  # Hook behavior tests
‚îÇ   ‚îú‚îÄ‚îÄ integration/            # End-to-end UNRDF porting tests
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ docs/                       # Documentation
    ‚îú‚îÄ‚îÄ UNRDF_PORTING_GUIDE.md
    ‚îî‚îÄ‚îÄ UNRDF_PORTING_VALIDATION.md
```

## Automation Commands (Poe)
- All build/test/lint workflows run via `poe <task>` where `<task>` is defined in `pyproject.toml` -> `[tool.poe.tasks]`.
- These Poe tasks wrap Ruff, mypy, pytest, docs, release steps with the exact flags we require.
- Never run ad-hoc shell commands when an equivalent `poe <task>` exists.

## Type Hints - Mandatory
Every function MUST have complete type hints:
```python
# ‚úÖ CORRECT
def process_hook(hook: Hook, context: HookContext) -> Receipt:
    """Process a hook with full context.

    Parameters
    ----------
    hook : Hook
        The hook to process
    context : HookContext
        Execution context with metadata

    Returns
    -------
    Receipt
        Immutable execution receipt
    """
    ...

# ‚ùå WRONG
def process_hook(hook, context):  # Missing types!
    ...
```

### Type Annotations Rules
- All function parameters: `param: Type`
- All return types: `-> ReturnType`
- All class attributes: `attribute: Type`
- Generics: `List[T]`, `Dict[K, V]`, `Optional[X]`
- Union types: `Union[A, B]` or `A | B` (Python 3.10+)
- Callbacks: `Callable[[Arg], ReturnType]`

### Dataclass Immutability
Use frozen dataclasses for value objects:
```python
from dataclasses import dataclass

@dataclass(frozen=True)
class Receipt:
    """Immutable hook execution receipt."""
    execution_id: str
    hook_id: str
    result: bool
```

## Testing - Chicago School TDD
### Test-First Development
1. Write tests FIRST (before implementation)
2. Tests specify behavior, not implementation
3. No mocking of domain objects (Hook, Receipt, Condition, etc.)
4. Real I/O, real SPARQL evaluation, real metrics

### Test Markers
```python
@pytest.mark.integration      # Integration tests
@pytest.mark.security         # Security tests
@pytest.mark.performance      # Performance tests
@pytest.mark.slow            # Long-running tests (deselect with -m "not slow")
```

### Test Organization
```
tests/
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ test_core.py          # Hook, HookReceipt, HookRegistry
‚îÇ   ‚îú‚îÄ‚îÄ test_conditions.py    # All condition types
‚îÇ   ‚îú‚îÄ‚îÄ test_lifecycle.py     # HookExecutionPipeline
‚îÇ   ‚îú‚îÄ‚îÄ test_security.py      # ErrorSanitizer, SandboxRestrictions
‚îÇ   ‚îú‚îÄ‚îÄ test_performance.py   # PerformanceOptimizer, QueryCache
‚îÇ   ‚îú‚îÄ‚îÄ test_policy_packs.py  # PolicyPackManager
‚îÇ   ‚îú‚îÄ‚îÄ test_file_resolver.py # FileResolver
‚îÇ   ‚îî‚îÄ‚îÄ test_unrdf_integration.py  # Hook-UNRDF interaction
‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îî‚îÄ‚îÄ test_unrdf_porting.py # All 8 UNRDF patterns validated
‚îî‚îÄ‚îÄ ...
```

### Test Naming
```python
# ‚úÖ CORRECT - Describes behavior
def test_hook_execution_with_error_sanitization():
    """Errors are sanitized before storage in receipt."""

def test_cache_hit_reduces_latency():
    """Query cache hit should reduce latency."""

# ‚ùå WRONG - Too vague
def test_hook():
def test_error():
```

## Code Style - NumPy Docstrings
Every public class/function needs NumPy-style docstrings:
```python
def execute_hook(hook: Hook, event: Dict[str, Any]) -> Receipt:
    """Execute a single hook against an event.

    Parameters
    ----------
    hook : Hook
        Hook definition with condition and handler
    event : Dict[str, Any]
        Event triggering hook execution

    Returns
    -------
    Receipt
        Immutable record of execution with result and metadata

    Raises
    ------
    ValueError
        If hook definition is invalid
    TimeoutError
        If execution exceeds timeout limit

    Examples
    --------
    >>> hook = Hook(name="test", condition=ThresholdCondition(5), handler=lambda e: True)
    >>> result = execute_hook(hook, {"count": 10})
    >>> assert result.success
    """
```

## Linting & Formatting - Strictest
### Run Before Commit
```bash
poe format        # Format code
poe lint          # Fix linting issues
poe type-check    # Type check
poe test          # Run all tests
```

Or via `git hooks` (automatic):
```bash
git commit   # Runs pre-commit (fast, <10s)
git push     # Runs pre-push (heavy, 30-120s)
```

### Ruff Configuration
From `pyproject.toml`:
```toml
[tool.ruff]
line-length = 88  # Black-compatible - STRICT ENFORCEMENT

[tool.ruff.lint]
select = ["E", "F", "B", "W", "I", "N", "UP", "PL", "RUF"]
ignore = ["D203", "D213", "COM812", "ISC001"]
unfixable = ["F401", "F841"]  # Manual review required
```

### Line Length: 88 Characters MAX (ENFORCED)
```python
# ‚ùå WRONG - Line too long (blocks push)
result = some_function(first_param, second_param, third_param, fourth_param)

# ‚úÖ CORRECT - Break into multiple lines
result = some_function(
    first_param,
    second_param,
    third_param,
    fourth_param,
)
```

### Unused Imports/Variables: REMOVE IMMEDIATELY
```python
# ‚ùå WRONG - F401 (unused import) blocks push
from typing import Dict, List, Optional  # Optional unused? REMOVE IT

# ‚ùå WRONG - F841 (unused variable) blocks push
result = compute()  # If never used, REMOVE IT
```

### Mypy Configuration (Strictest)
From `pyproject.toml`:
```toml
[tool.mypy]
strict = true                      # All strictest checks enabled
disallow_any_unimported = true     # No `Any` imports
disallow_incomplete_defs = true    # All types complete
disallow_untyped_defs = true       # All functions typed
disallow_untyped_calls = true      # All calls typed
check_untyped_defs = true          # Check untyped functions
no_implicit_optional = true        # No implicit Optional
```

## UNRDF Porting Rules
### 8 Critical Patterns to Port
1. **Hook Executor** - Timeout, execution ID, error sanitization, phases
2. **Condition Evaluator** - 8 condition types, file resolution
3. **Error Sanitizer** - Remove sensitive info from errors
4. **Sandbox Restrictions** - Resource/access limits
5. **Performance Optimizer** - Latency tracking, SLO monitoring
6. **Query Cache** - SPARQL result caching with TTL/LRU
7. **Policy Pack Manager** - Bundle, version, activate hooks
8. **Lockchain Writer** - Cryptographic provenance, chain anchoring

### Pattern Requirements
- Port JavaScript ‚Üí Python idiomatically (not mechanical translation)
- Use Python dataclasses instead of TypeScript interfaces
- Use `frozen=True` for immutable value objects
- Full type hints (Python 3.12+)
- Chicago School TDD (test-first, real objects)
- SLO targets: p99 < 100ms for all operations

### Integration Points
Each pattern must integrate with:
- Hook lifecycle (phases: PRE, EVALUATE, RUN, POST)
- Error handling (sanitization at boundaries)
- Performance tracking (metrics in receipts)
- RDF/SPARQL engine (UnrdfEngine)

## Build & CI Requirements

### Pre-Commit Hook (scripts/git_hooks/pre-commit) - FAST (<10s)
Allows backup commits but blocks obvious issues:
- Hardcoded secrets scan
- Implementation lies (TODO/FIXME/WIP markers)
- Format check (ruff format --check)
- Basic lint (staged files only)

### Pre-Push Hook (scripts/git_hooks/pre-push) - HEAVY (30-120s)
**BLOCKS CORRUPTING THE PROJECT** with full validation:
- Implementation lies scan (comprehensive)
- Ruff lint (ALL src/ and tests/ files)
- Mypy strict type checking (ALL src/ files)
- Full test suite (PYTHONWARNINGS=error)

**ANDON CORD:** ANY failure blocks the push. Fix issues before pushing.

### Poe Automation Tasks
```bash
# Development
poe format           # Format code (Ruff)
poe lint             # Lint & fix (Ruff)
poe type-check       # Type check (Mypy)
poe test             # Run tests (Pytest)

# Verification
poe verify           # All checks + tests
poe ci               # CI pipeline: format-check, lint, types, tests, docs

# Release
poe release-check    # All checks (no fixes)
poe prod-build       # Strict production build

# UNRDF-Specific
poe unrdf-validate   # Type-check + UNRDF tests
poe unrdf-full       # All UNRDF porting tests
```

### Pytest Configuration (Strictest)
From `pyproject.toml`:
```toml
[tool.pytest.ini_options]
addopts = "--color=yes --doctest-modules --exitfirst --failed-first --verbosity=2 --strict-markers"
xfail_strict = true         # xfail must actually fail
asyncio_mode = "auto"       # Async test support
```

## Git Hooks Setup
```bash
# Install hooks (one-time setup)
git config core.hooksPath scripts/git_hooks

# Hooks are now active - they run automatically
git commit  # Runs pre-commit (fast, <10s)
git push    # Runs pre-push (heavy, 30-120s)
```

## Imports - Absolute Only
```python
# ‚úÖ CORRECT
from kgcl.hooks.core import Hook, HookReceipt
from kgcl.hooks.conditions import SparqlAskCondition
from kgcl.unrdf_engine.engine import UnrdfEngine

# ‚ùå WRONG - Relative imports banned
from ..hooks.core import Hook
from . import utils
from .conditions import SparqlAskCondition
```

## Logging, Not Print
```python
import logging

logger = logging.getLogger(__name__)

# ‚úÖ CORRECT
logger.info("Hook executed", extra={"hook_id": hook.name, "duration_ms": duration})
logger.error("Failed to load file", exc_info=True)

# ‚ùå WRONG
print("Hook executed")
print(f"Duration: {duration}ms")
```

## Secrets Management
```python
# ‚úÖ CORRECT
import os
api_key = os.getenv("API_KEY")  # From environment
config = {"key": api_key}  # Set in CI/deployment

# ‚ùå WRONG
config = {"key": "sk-abc123xyz"}  # Hardcoded!
password = "admin123"  # Secret in code!
```

## Performance Targets (from UNRDF)
| Operation | p50 | p99 | Target |
|-----------|-----|-----|--------|
| Hook registration | 0.1ms | 1.0ms | <5ms |
| Condition eval | 0.2ms | 2.0ms | <10ms |
| Hook execution | 1.0ms | 10.0ms | <100ms |
| Receipt write | 5.0ms | 5.0ms | <10ms |
| Full pipeline | 2.0ms | 50.0ms | <500ms |

## Error Handling
```python
# ‚úÖ CORRECT - Sanitized error
from kgcl.hooks.security import ErrorSanitizer

try:
    result = evaluate_condition(condition)
except Exception as e:
    sanitizer = ErrorSanitizer()
    sanitized = sanitizer.sanitize(e)
    logger.error(sanitized.message, extra={"code": sanitized.code})
    raise

# ‚ùå WRONG - Raw error leaks details
except Exception as e:
    logger.error(str(e))  # Exposes stack trace, file paths!
    raise
```

## File Organization Rules
- Max file size: 500 lines (unless justified for cohesion)
- Max function size: 40 lines
- Max class complexity: 7 methods per class
- Separate concerns: hooks, ontology, observability, CLI
- Related tests in parallel directories

## Documentation
- README.md - Project overview
- docs/UNRDF_PORTING_GUIDE.md - All 8 patterns
- docs/UNRDF_PORTING_VALIDATION.md - Test results
- pyproject.toml docstrings - Tool configuration
- NumPy docstrings - All public APIs
- Comments - Only for "why", not "what"

## Version Management
- Semantic versioning: MAJOR.MINOR.PATCH
- Commit: `bump: v$current_version ‚Üí v$new_version`
- Tags: `v$version`
- Changelog: Updated on every bump (via commitizen)

## Cursor Commands Available
See `.cursor/commands/` for:
- `80-20-fill-gaps.md` - Apply 80/20 principle
- `eliminate-muda.md` - Remove waste
- `verify-tests.md` - Validate test coverage
- `expert-testing-patterns.md` - TDD patterns
- And more...

## Final Checklist Before Push
- [ ] Line length ‚â§ 88 characters (E501)
- [ ] No unused imports (F401)
- [ ] No unused variables (F841)
- [ ] All functions have type hints
- [ ] All tests pass: `uv run poe test`
- [ ] Lint passes: `uv run ruff check src/ tests/`
- [ ] Types pass: `uv run mypy src/ --strict`
- [ ] Format correct: `uv run ruff format --check src/ tests/`
- [ ] NumPy docstrings on public APIs
- [ ] No hardcoded secrets
- [ ] No TODO/FIXME/WIP markers
- [ ] New features have tests
- [ ] Integration tests marked with `@pytest.mark.integration`

## Success Metrics
‚úÖ All tests pass: `127 passed` (UNRDF porting)
‚úÖ Type safety: `mypy` with `strict = true`
‚úÖ Code quality: All Ruff rules enabled
‚úÖ Performance: SLO targets met
‚úÖ Documentation: Complete with examples
‚úÖ Production-ready: No technical debt

## Critical Non-Negotiables (Adopted from clap-noun-verb)
- **Never trust text, only test results.** Every claim must be backed by a passing test run.
- **Build System Enforcement.** Always use the Poe tasks defined in `pyproject.toml` (`poe format`, `poe lint`, `poe verify`, etc.) for format, lint, type, and test workflows. Ad-hoc scripts are banned.
- **Git Hooks.** Never bypass hooks (`--no-verify` prohibited). Fix issues instead of skipping the gate.
- **Timeout SLAs.** All CLI/test invocations must be wrapped with sane timeouts (e.g., quick checks 5s, compilation 10s, unit tests 1s, integration 30s, long ops 60s). Timeouts expose hung workflows early.

## Behavior Verification Reinforcement
- Tests MUST verify observable behavior/state, not merely `assert result.is_ok()`.
- Apply Chicago School AAA structure (Arrange ‚Üí Act ‚Üí Assert) with real collaborators‚Äîno mocking of domain objects.
- Keep total test suite runtime under **1 second**; optimize or parallelize if needed.

## Prohibited Patterns (Extended)
- No placeholders, TODOs, stubs, or speculative scaffolding.
- No `print`/`logging` trickery to ‚Äúfake‚Äù behavior; rely on structured errors and receipts.
- No `.unwrap()`, `.expect()`, or silent exception swallowing anywhere.
- No runtime checks when invariants can be enforced via types/dataclasses.
- Never rebase shared branches; prefer merge or fast-forward.

## Completion Workflow (Mandatory)
1. **Run tests immediately:** `poe test` (with timeout) before claiming progress. If failures occur, stop and analyze.
2. **Create rich TODOs:** For each failure capture test name, error, file, hypothesized root cause, fix plan, and status. Batch at least 10 related TODO entries per failure set.
3. **Systematic fix cycle:** Investigate ‚Üí implement fix ‚Üí run targeted test ‚Üí update TODO status.
4. **Re-run full suite:** `poe test` again (with timeout) to confirm everything passes.
5. **Verify gates:** Ensure lint, type-check, docs, and hooks all pass before concluding work.

## TODO Discipline
- TODO lists contain **‚â•10 items**; partial lists are forbidden.
- All TODO items must be fully resolved before moving to subsequent tasks.
- Update TODO tracking immediately after each fix; no stale entries.

## Workflow Guardrails
- Always surface the build/verify button in planning updates so others can rerun checks quickly.
- Document second- and third-idea options (80/20 thinking) when proposing solutions; default to the sweet-spot ‚Äúsecond idea‚Äù unless higher leverage is justified.
- Treat performance budgets (p99 targets above) as blocking requirements‚Äîprofiling data must accompany any exception request.
